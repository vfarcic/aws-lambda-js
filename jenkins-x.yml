buildPack: none
pipelineConfig:
  env:
  - name: REGION	
    value: us-west-2	
  - name: AWS_ACCESS_KEY_ID	
    valueFrom:	
      secretKeyRef:	
        key: access-key-id	
        name: aws-lambda	
  - name: AWS_SECRET_ACCESS_KEY	
    valueFrom:	
      secretKeyRef:	
        key: secret-access-key	
        name: aws-lambda
  agent:
    container: nodejs
  pipelines:
    release:
      pipeline:
        agent:
          image: vfarcic/lambda-nodejs:10
        stages:
        - name: setVersion
          steps:
          - sh: echo \$(jx-release-version) > VERSION
            name: next-version
            comment: so we can retrieve the version in later steps
          - sh: jx step tag --version \$(cat VERSION)
            name: tag-version
        - name: promote
          steps:
          - name: changelog
            sh: jx step changelog --batch-mode --version v\$(cat ../../VERSION)
          - name: deploy
            sh: serverless deploy --verbose --region $REGION --stage production
    pullRequest:
      pipeline:
        agent:
          image: vfarcic/lambda-nodejs:10
        stages:
        - name: build
          steps:
          - name: deploy
            sh: serverless deploy --verbose --region $REGION --stage pr

